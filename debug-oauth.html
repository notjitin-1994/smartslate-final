<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Debug</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>OAuth Debug Page</h1>
    <div id="debug-info"></div>
    <button onclick="startOAuth()">Start Google OAuth</button>
    <button onclick="checkLocalStorage()">Check localStorage</button>
    <button onclick="clearStorage()">Clear Storage</button>
    
    <script>
        const debugDiv = document.getElementById('debug-info');
        
        // Initialize Supabase client
        const supabaseUrl = 'https://oyjslszrygcajdpwgxbe.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95anNsc3pyeWdjYWpkcHdneGJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDgyNjEsImV4cCI6MjA3MDcyNDI2MX0.kMjNtKIrzmYHEKJFKsY75-kp8PeOib2BYDxHZ_lmZ-Y';
        
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                storage: window.localStorage,
                persistSession: true,
                autoRefreshToken: false,
                detectSessionInUrl: true,
                flowType: 'pkce',
            },
        });
        
        function log(message) {
            console.log(message);
            debugDiv.innerHTML += '<p>' + message + '</p>';
        }
        
        function checkLocalStorage() {
            log('=== localStorage Check ===');
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.includes('supabase') || key.includes('auth') || key.includes('pkce')) {
                    try {
                        const value = localStorage.getItem(key);
                        log(`${key}: ${value}`);
                    } catch (e) {
                        log(`${key}: [Error reading]`);
                    }
                }
            });
        }
        
        function clearStorage() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.includes('supabase') || key.includes('auth') || key.includes('pkce')) {
                    localStorage.removeItem(key);
                    log(`Cleared: ${key}`);
                }
            });
        }
        
        async function startOAuth() {
            try {
                log('Starting OAuth...');
                checkLocalStorage();
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'http://localhost:3000/auth/callback',
                    }
                });
                
                if (error) {
                    log('OAuth Error: ' + error.message);
                    return;
                }
                
                log('OAuth URL: ' + (data?.url || 'No URL returned'));
                
                if (data?.url) {
                    window.location.href = data.url;
                }
            } catch (e) {
                log('Exception: ' + e.message);
            }
        }
        
        // Check if we're on the callback page
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        
        if (code) {
            log('Found auth code: ' + code);
            checkLocalStorage();
        }
        
        if (error) {
            log('Found error: ' + error);
        }
        
        // Initial check
        checkLocalStorage();
    </script>
</body>
</html>
